name: CI/CD Pipeline for Vue.js Project

on:
  push:
    branches:
      - main

jobs:
  lint:
    name: Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Use Node.js 16.x
        uses: actions/setup-node@v2
        with:
          node-version: 16.x

      - name: Install Dependencies
        working-directory: ./cicd-frontend-main
        run: |
          npm cache clean --force
          rm -rf node_modules
          npm install --legacy-peer-deps

      - name: Run ESLint
        working-directory: ./cicd-frontend-main
        run: npx eslint 'src/**/*.{js,vue}'

  test:
    name: Testing
    needs: lint  # Run tests only after linting succeeds
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Use Node.js 16.x
        uses: actions/setup-node@v2
        with:
          node-version: 16.x

      - name: Install Dependencies
        working-directory: ./cicd-frontend-main
        run: |
          npm cache clean --force
          rm -rf node_modules
          npm install --legacy-peer-deps

      - name: Run Tests
        working-directory: ./cicd-frontend-main
        run: npm run test

  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: test  # Deploy only after successful tests
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Use Node.js 16.x
        uses: actions/setup-node@v2
        with:
          node-version: 16.x

      - name: Install Dependencies
        working-directory: ./cicd-frontend-main
        run: |
          npm cache clean --force
          rm -rf node_modules
          npm install --legacy-peer-deps

      - name: Build Docker Image
        run: |
          docker build -t eeba19/cicd-frontend .
          docker tag eeba19/cicd-frontend eeba19/cicd-frontend:${GITHUB_RUN_NUMBER}

      - name: Push Docker Image
        run: |
          echo ${{ secrets.DOCKERHUB_TOKEN }} | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
          docker push eeba19/cicd-frontend:${GITHUB_RUN_NUMBER}
          docker push eeba19/cicd-frontend:latest

      - name: Deploy App
        run: |
          echo "Deploying app..."
          # Add deployment steps as per your deployment strategy
